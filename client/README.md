# formgen Runtime Client

JavaScript/TypeScript runtime for resolving relationship fields in formgen-generated forms.

## Overview

This package provides browser-side relationship resolution for forms generated by the formgen Go library. Instead of server-side data fetching, the runtime reads `data-*` attributes from HTML and fetches relationship options from your REST API endpoints when forms load.

## Directory Structure

```
client/
├── src/                  # TypeScript source
│   ├── index.ts         # Main entry point, auto-init
│   ├── resolver.ts      # Core fetch/transform/render logic
│   ├── registry.ts      # Element registration and lifecycle
│   ├── config.ts        # Global configuration types
│   ├── dom.ts           # DOM utilities and dataset parsing
│   ├── auth.ts          # Auth header resolution
│   ├── state.ts         # State management helpers
│   ├── errors.ts        # Custom error types
│   ├── timers.ts        # Throttle/debounce for search
│   └── frameworks/
│       └── preact.ts    # Preact hooks integration
├── dist/                # Build output
│   ├── browser/         # IIFE bundles for <script> tags
│   ├── esm/             # ESM for bundlers
│   └── types/           # TypeScript declarations
├── scripts/
│   └── build.ts         # esbuild configuration
├── package.json
├── tsconfig.json
└── tsconfig.build.json
```

## Building

```bash
# Install dependencies
npm install

# Build all outputs (types + bundles)
npm run build

# Watch mode for development
npm run watch

# Analyze bundle size
npm run build:stats
```

## Outputs

- **Browser bundle**: `dist/browser/formgen-relationships.min.js` (IIFE, 22KB minified)
- **ESM**: `dist/esm/index.js` (for Vite/webpack)
- **Preact**: `dist/browser/frameworks/preact.min.js`
- **Types**: `dist/types/index.d.ts`

## Usage

### Vanilla HTML

```html
<script src="/runtime/formgen-relationships.min.js" defer></script>
<script>
  window.addEventListener('DOMContentLoaded', function () {
    window.FormgenRelationships.initRelationships().catch(console.error);
  });
</script>

<form data-formgen-auto-init="true">
  <select
    name="publisher_id"
    data-relationship-type="belongsTo"
    data-endpoint-url="/api/publishers"
    data-endpoint-value-field="id"
    data-endpoint-label-field="name">
  </select>
</form>
```

### With Configuration

```javascript
import { initRelationships } from '@goliatone/formgen-runtime';

await initRelationships({
  buildHeaders: (ctx) => ({
    'Authorization': `Bearer ${getToken()}`,
  }),
  transformOptions: (data) => data.items || data,
  onError: (error, element) => {
    console.error('Failed to load options', error);
  }
});
```

### Preact

```typescript
import { useRelationshipOptions } from '@goliatone/formgen-runtime/frameworks/preact';

function PublisherSelect({ field }) {
  const { options, loading, error } = useRelationshipOptions(field);

  return (
    <select name={field.name}>
      {loading ? <option>Loading...</option> : null}
      {options.map(opt => (
        <option key={opt.value} value={opt.value}>{opt.label}</option>
      ))}
    </select>
  );
}
```

## Integration with formgen

The Go HTTP example serves this bundle automatically:

```go
// examples/http/main.go
if _, err := os.Stat("client/dist/browser"); err == nil {
    mux.Handle("/runtime/", http.StripPrefix("/runtime/",
        http.FileServer(http.Dir("client/dist/browser"))))
}
```

Start the example server:

```bash
go run examples/http/main.go -source examples/http/schema.json
# Visit http://localhost:8080/form?operation=author:create
```

## Features

- ✅ Auto-init from `data-formgen-auto-init` forms
- ✅ Fetch options from REST endpoints
- ✅ Dependent field refresh (cascade dropdowns)
- ✅ Search mode with throttle/debounce
- ✅ Auth header resolution (meta tags, data attributes, callbacks)
- ✅ In-memory caching with TTL
- ✅ JSON submission encoding for has-many
- ✅ Error handling with retry/backoff
- ✅ Lifecycle events (loading, success, error)
- ✅ Custom renderer registration

## Documentation

See parent repository docs:
- [JS_TDD.md](../JS_TDD.md) - Technical design document
- [JS_TSK.md](../JS_TSK.md) - Implementation tasks
- [REL_TDD.md](../REL_TDD.md) - Relationship feature overview
- [go-form-gen.md](../go-form-gen.md) - Main formgen documentation

## License

Same as parent repository (formgen).
