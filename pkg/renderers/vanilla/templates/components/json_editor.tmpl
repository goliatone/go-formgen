{% set data_attrs = field.metadata.__data_attrs -%}
{% set validation_state = field.metadata["validation.state"] -%}
{% set readonly_value = field.readonly or field.uiHints.readonly == "true" or field.metadata.readonly == "true" or field.metadata["prefill.readonly"] == "true" -%}
{% set disabled_value = field.disabled or field.uiHints.disabled == "true" or field.metadata.disabled == "true" or field.metadata["prefill.disabled"] == "true" -%}
{% set provenance = field.metadata["prefill.provenance"] -%}
{% if collapsed %}{% set collapsed_attr = "true" %}{% else %}{% set collapsed_attr = "false" %}{% endif %}
{% set state_value = "invalid" -%}
{% if valid %}{% set state_value = "valid" %}{% endif %}
{% set expanded_value = "true" -%}
{% if collapsed %}{% set expanded_value = "false" %}{% endif %}
{% set schema_hint_value = "" -%}
{% if schema_hint %}{% set schema_hint_value = schema_hint %}{% endif %}
{% if not schema_hint_value and field.description %}{% set schema_hint_value = field.description %}{% endif %}
{% if not schema_hint_value %}{% set schema_hint_value = "Provide a JSON object; unknown keys are preserved." %}{% endif %}
{% set placeholder_value = "" -%}
{% if example %}{% set placeholder_value = example %}{% endif %}
{% if not placeholder_value and field.placeholder %}{% set placeholder_value = field.placeholder %}{% endif %}
<div class="space-y-2" data-json-editor="true" data-json-editor-collapsed="{{ collapsed_attr }}" data-json-editor-state="{{ state_value }}">
    <div class="flex items-start justify-between gap-2">
        <p class="text-xs text-gray-500 dark:text-gray-400 leading-5">{{ schema_hint_value }}</p>
        <div class="flex items-center gap-2">
            <button type="button" class="text-xs font-medium text-gray-700 hover:text-gray-900 dark:text-gray-200" data-json-editor-toggle aria-expanded="{{ expanded_value }}">
                {% if collapsed %}Expand{% else %}Collapse{% endif %}
            </button>
            <button type="button" class="text-xs font-medium text-blue-600 hover:text-blue-700" data-json-editor-format>Pretty print</button>
        </div>
    </div>
    <textarea
        id="fg-{{ field.name }}"
        name="{{ field.name }}"
        class="font-mono text-sm leading-6 w-full border {% if validation_state == "invalid" %}border-red-500 focus:border-red-500 focus:ring-red-500{% else %}border-gray-200 focus:border-blue-500 focus:ring-blue-500{% endif %} rounded-lg p-3 bg-white text-gray-900 dark:bg-slate-900 dark:text-gray-100 dark:border-gray-700{% if collapsed %} hidden{% endif %}"
        rows="8"
        {% if placeholder_value %}placeholder="{{ placeholder_value }}"{% endif %}
        {% if field.required %}required{% endif %}
        {% if disabled_value %}disabled{% endif %}
        {% if readonly_value %}readonly{% endif %}
        {% if readonly_value %}aria-readonly="true"{% endif %}
        {% if validation_state == "invalid" %}aria-invalid="true"{% endif %}
        {% if provenance %}data-prefill-provenance="{{ provenance }}"{% endif %}
        data-json-editor-input="true"
        {% if data_attrs %}{{ data_attrs|safe }}{% endif %}
    >{{ value|safe }}</textarea>
    <pre class="font-mono text-xs leading-6 border border-dashed {% if validation_state == "invalid" %}border-red-400 bg-red-50 text-red-700{% else %}border-gray-200 bg-gray-50 text-gray-800{% endif %} rounded-lg p-3 {% if not collapsed %}hidden{% endif %}" data-json-editor-preview data-state="{{ state_value }}">{{ value|safe }}</pre>
</div>
