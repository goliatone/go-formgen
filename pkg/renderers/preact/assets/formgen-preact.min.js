(function (global) {
  "use strict";

  function byId(id) {
    return document.getElementById(id);
  }

  function safeID(value) {
    if (!value) {
      return "field";
    }
    return String(value).replace(/[^a-zA-Z0-9-_:.]/g, "-");
  }

  function readPayload(node) {
    if (!node) {
      return null;
    }
    var text = node.textContent || node.innerText || "";
    if (!text) {
      return null;
    }
    try {
      return JSON.parse(text);
    } catch (err) {
      console.error("formgen preact: failed to parse payload", err);
      return null;
    }
  }

  function ensurePreact() {
    var api = global.preact || {};
    if (typeof api.h !== "function" || typeof api.render !== "function") {
      console.warn("formgen preact: window.preact missing; rendering fallback pre block");
      return null;
    }
    return api;
  }

  function text(value) {
    return value == null ? "" : String(value);
  }

  function normalize(value) {
    return typeof value === "string" ? value.trim() : "";
  }

  function toKebab(input) {
    if (!input) {
      return "";
    }
    var result = "";
    var last = "";
    for (var i = 0; i < input.length; i += 1) {
      var ch = input[i];
      if (ch === ".") {
        result += "-";
        last = "-";
        continue;
      }
      var lower = ch.toLowerCase();
      if (ch !== lower) {
        if (i > 0 && last !== "-" && last !== "") {
          result += "-";
        }
        result += lower;
        last = lower;
        continue;
      }
      result += lower;
      last = lower;
    }
    return result;
  }

  function parseCurrentValues(field) {
    var metadata = field && field.metadata ? field.metadata : null;
    if (!metadata) {
      return [];
    }
    var current = metadata["relationship.current"];
    if (!current) {
      return [];
    }
    try {
      var parsed = JSON.parse(current);
      if (Array.isArray(parsed)) {
        return parsed.map(text);
      }
      if (parsed == null) {
        return [];
      }
      return [text(parsed)];
    } catch (_err) {
      return [text(current)];
    }
  }

  function shouldRenderField(field) {
    if (!field) {
      return false;
    }
    var rel = field.relationship || null;
    if (rel && rel.sourceField) {
      return false;
    }
    return true;
  }

  function relationshipAttributes(field) {
    var attrs = {};
    if (!field) {
      return attrs;
    }
    var rel = field.relationship || null;
    if (rel) {
      if (rel.kind) {
        attrs["data-relationship-type"] = rel.kind;
      }
      if (rel.target) {
        attrs["data-relationship-target"] = rel.target;
      }
      if (rel.foreignKey) {
        attrs["data-relationship-foreign-key"] = rel.foreignKey;
      }
      if (rel.cardinality) {
        attrs["data-relationship-cardinality"] = rel.cardinality;
      }
      if (rel.inverse) {
        attrs["data-relationship-inverse"] = rel.inverse;
      }
    }

    var metadata = field.metadata || null;
    if (!metadata) {
      return attrs;
    }
    var keys = Object.keys(metadata).sort();
    for (var i = 0; i < keys.length; i += 1) {
      var key = keys[i];
      var value = metadata[key];
      if (!value) {
        continue;
      }
      if (key === "relationship.current") {
        attrs["data-relationship-current"] = value;
        continue;
      }
      if (key.indexOf("relationship.endpoint.") !== 0) {
        continue;
      }
      var suffix = key.slice("relationship.endpoint.".length);
      if (suffix.indexOf("auth.") === 0) {
        var authSuffix = suffix.slice("auth.".length);
        if (authSuffix) {
          attrs["data-auth-" + toKebab(authSuffix)] = value;
        }
        continue;
      }
      if (suffix === "refreshOn") {
        attrs["data-endpoint-refresh-on"] = value;
        continue;
      }
      attrs["data-endpoint-" + toKebab(suffix)] = value;
    }

    return attrs;
  }

  function baseControlAttrs(field, id, hints) {
    var attrs = {
      id: id,
      name: field.name || id,
      class: "fg-preact-input",
    };
    if (field.required) {
      attrs.required = "required";
    }
    var placeholder = field.placeholder || normalize(hints && hints.placeholder);
    if (placeholder) {
      attrs.placeholder = placeholder;
    }
    return Object.assign(attrs, relationshipAttributes(field));
  }

  function selectOptions(h, field, placeholder) {
    var options = [];
    var enumValues = Array.isArray(field.enum) ? field.enum : [];
    var currentValues = parseCurrentValues(field);
    if (placeholder && (!enumValues.length || currentValues.length === 0)) {
      options.push(
        h("option", { value: "" }, placeholder)
      );
    }
    if (enumValues.length > 0) {
      var current = text(field["default"]);
      for (var i = 0; i < enumValues.length; i += 1) {
        var label = text(enumValues[i]);
        var attrs = { value: label };
        if (label === current) {
          attrs.selected = "selected";
        }
        options.push(h("option", attrs, label));
      }
    } else if (currentValues.length > 0) {
      for (var j = 0; j < currentValues.length; j += 1) {
        var value = currentValues[j];
        options.push(
          h("option", { value: value, selected: "selected" }, value)
        );
      }
    }
    if (options.length === 0) {
      options.push(
        h("option", { value: "" }, placeholder || "Select an option")
      );
    }
    return options;
  }

  function renderSelectControl(h, field, id, hints) {
    var attrs = baseControlAttrs(field, id, hints);
    delete attrs.placeholder;

    var cardinality = normalize(hints && hints.cardinality).toLowerCase();
    if (cardinality === "many") {
      attrs.multiple = "multiple";
      attrs["data-relationship-collection"] = "many";
    }

    var placeholder = field.placeholder || normalize(hints && hints.placeholder);
    if (!placeholder && field.label) {
      placeholder = "Select " + field.label;
    }

    return h("select", attrs, selectOptions(h, field, placeholder));
  }

  function renderTextarea(h, field, id, hints) {
    var attrs = baseControlAttrs(field, id, hints);
    return h("textarea", attrs, text(field["default"]));
  }

  function controlForField(h, field, id) {
    var hints = field.uiHints || {};
    var inputHint = normalize(hints.input).toLowerCase();

    if (field.nested && field.nested.length) {
      return h("div", { class: "fg-preact-nested" }, buildFieldList(h, field.nested));
    }

    if (inputHint === "select" || (Array.isArray(field.enum) && field.enum.length > 0)) {
      return renderSelectControl(h, field, id, hints);
    }

    if (inputHint === "collection" && normalize(hints.cardinality).toLowerCase() === "many") {
      return renderSelectControl(h, field, id, hints);
    }

    if (normalize(hints.widget).toLowerCase() === "textarea") {
      return renderTextarea(h, field, id, hints);
    }

    var type = String(field.type || "string").toLowerCase();
    if (type === "boolean") {
      var boolAttrs = baseControlAttrs(field, id, hints);
      boolAttrs.type = "checkbox";
      if (field["default"] === true) {
        boolAttrs.checked = "checked";
      }
      return h("input", boolAttrs);
    }

    if (type === "array" && field.items) {
      return h("div", { class: "fg-preact-nested" }, buildFieldList(h, [field.items]));
    }

    var attrs = baseControlAttrs(field, id, hints);
    var explicitType = normalize(hints.inputType || hints.inputtype);
    if (explicitType) {
      attrs.type = explicitType;
    } else if (type === "integer" || type === "number") {
      attrs.type = "number";
      attrs.step = type === "integer" ? "1" : "any";
    } else {
      attrs.type = "text";
    }

    if (attrs.type !== "file" && field["default"] != null) {
      attrs.value = text(field["default"]);
    }

    return h("input", attrs);
  }

  function buildFieldList(h, fields) {
    if (!Array.isArray(fields)) {
      return [];
    }
    return fields.filter(shouldRenderField).map(function (field) {
      var id = "fg-" + safeID(field.name || field.label);
      var label = field.label || field.name || "Field";
      var children = [
        h(
          "label",
          { class: "fg-preact-label", htmlFor: id },
          label,
          field.required ? h("span", { class: "fg-preact-required" }, " *") : null
        ),
      ];
      children.push(controlForField(h, field, id));
      if (field.description) {
        children.push(h("p", { class: "fg-preact-help" }, field.description));
      }
      return h("div", { class: "fg-preact-field" }, children);
    });
  }

  function mountFallback(target, data) {
    target.textContent = JSON.stringify(data, null, 2);
  }

  function maybeInitRelationships() {
    var api = global.FormgenRelationships;
    if (!api || typeof api.initRelationships !== "function") {
      return;
    }
    try {
      var result = api.initRelationships();
      if (result && typeof result.then === "function") {
        result.catch(function (error) {
          console.error("formgen preact: initRelationships failed", error);
        });
      }
    } catch (err) {
      console.error("formgen preact: initRelationships error", err);
    }
  }

  function bootstrap() {
    var mount = byId("formgen-preact-root");
    var dataNode = byId("formgen-preact-data");
    if (!mount || !dataNode) {
      return;
    }
    var model = readPayload(dataNode) || { operationId: "", fields: [] };
    var api = ensurePreact();
    if (!api) {
      mountFallback(mount, model);
      return;
    }
    var h = api.h;
    var render = api.render;

    function App() {
      return h(
        "section",
        { class: "fg-preact" },
        [
          h(
            "h1",
            { class: "fg-preact-heading" },
            model.summary || model.operationId || "Generated Form"
          ),
          model.description
            ? h("p", { class: "fg-preact-description" }, model.description)
            : null,
          h(
            "form",
            {
              class: "fg-preact-form",
              noValidate: "noValidate",
              "data-formgen-auto-init": "true",
            },
            buildFieldList(h, model.fields)
          ),
        ]
      );
    }

    render(h(App, null), mount);
    maybeInitRelationships();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", bootstrap);
  } else {
    bootstrap();
  }
})(window);
